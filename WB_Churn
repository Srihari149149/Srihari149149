import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LinearRegression
import os
from datetime import datetime
import warnings
warnings.filterwarnings('ignore')

# File paths
sales_file = r"C:\Users\P00993489\Downloads\GOmumbai.csv"
value_audit_file1 = r"C:\Users\P00993489\Downloads\Value_Audit.csv"
value_audit_file2 = r"C:\Users\P00993489\Downloads\Value_audit_2.csv"
od_data_path = r"C:\Users\P00993489\Downloads\OD_Data.xlsx"  # Path to OD data Excel workbook

# Define column names
sales_cols = ['Date', 'value', 'volume', 'territory', 'dealer code', 'category']  # Added category
audit_cols = ['Competitor__r.Name', 'Dealer__r.Account_Code__c', 'Dealer__r.Name', 'Value__c', 'Category__c']  # Added category

# Load and preprocess sales data
print("Loading sales data...")
sales_df = pd.read_csv(sales_file, usecols=sales_cols, encoding='latin1')
sales_df["date"] = pd.to_datetime(sales_df["Date"])
sales_df["month"] = sales_df["date"].dt.to_period("M").dt.to_timestamp()
sales_df["year"] = sales_df["date"].dt.year
sales_df["month_num"] = sales_df["date"].dt.month
sales_df['month_ordinal'] = sales_df['month'].map(lambda x: x.toordinal())

# Standardize dealer codes
sales_df['dealer_code'] = sales_df['dealer code'].astype(str).str[-6:]
sales_df = sales_df[~sales_df['dealer_code'].str.startswith('INB', na=False)]

print("Sales data shape:", sales_df.shape)


 Load and preprocess competitor data (Value Audit)
print("Loading competitor data...")
value_audit_df1 = pd.read_csv(value_audit_file1, usecols=audit_cols)
value_audit_df2 = pd.read_csv(value_audit_file2, usecols=audit_cols)

# Filter out 'APL' competitors and standardize dealer codes
value_audit_2024 = value_audit_df1[value_audit_df1['Competitor__r.Name'] != 'APL']
value_audit_2023 = value_audit_df2[value_audit_df2['Competitor__r.Name'] != 'APL']

value_audit_2024['dealer_code'] = value_audit_2024['Dealer__r.Account_Code__c'].astype(str).str[-6:]
value_audit_2023['dealer_code'] = value_audit_2023['Dealer__r.Account_Code__c'].astype(str).str[-6:]

print("Competitor data shapes:", value_audit_2024.shape, value_audit_2023.shape)
